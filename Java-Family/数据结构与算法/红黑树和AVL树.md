# 简介

1. AVL树：一棵AVL树或者是空树，或者是具有下列性质的二叉查找树——它的左子树和右子树都是AVL树，且左子树和右子树的高度之差的绝对值不超过1。

   ![img](https://520li.oss-cn-hangzhou.aliyuncs.com/img/20200611011419.png)

2. **红黑树是一种平衡二叉树**，同时它还满足下列5个特性：

   - 每个结点是红色或者黑色的。
   - **根结点是黑色的**。
   - 每个空结点（NULL/NIL）是黑色的。（这里将空结点作为一个特殊的结点对待，设定他们必须是黑色的。）
   - 如果一个**结点是红色的，则它的左右子结点都必须是黑色的**。（但**黑色结点的子结点可以是黑色的**。）
   - 对任意一个结点来说，从**它到空结点的所有路径必须包含相同数目的黑色结点**。

   注意：**新插入的节点颜色总是红色的**，这是因为插入一个红色节点比插入一个黑色节点违背红-黑规则的可能性更小，原因是插入黑色节点总会改变黑色高度（违背规则4），但是插入红色节点只有一半的机会会违背规则3（因为父节点是黑色的没事，父节点是红色的就违背规则3）。另外违背规则3比违背规则4要更容易修正。

   ![img](https://520li.oss-cn-hangzhou.aliyuncs.com/img/20200611011543.jpg)

3. 和红黑树相比，AVL树是**严格的平衡二叉树**，平衡条件必须满足（**所有节点的左右子树高度差不超过1**）。通过对任何一条从根到叶子的路径上各个节点着色的方式的限制，红黑树确保没有一条路径会比其它路径长出两倍，因此，**红黑树是一种弱平衡二叉树**（由于是弱平衡，可以看到，在相同的节点情况下，**AVL树的高度低于红黑树**）。

# 比较

红黑树的**查询性能略微逊色于AVL树，因为他比avl树会稍微不平衡最多一层**，也就是说红黑树的查询性能只比相同内容的avl树最多多一次比较，但是，红黑树在插入和删除上完爆avl树，**avl树每次插入删除会进行大量的平衡度计算**，而红黑树为了维持红黑性质所做的红黑变换和旋转的开销，相较于avl树为了**维持平衡的开销要小得多**。

**AVL树适合用于插入与删除次数比较少，但查找多的情况**；相对于要求严格的AVL树来说，**红黑树的旋转次数少，所以对于搜索、插入、删除操作较多的情况下，我们就用红黑树。**

红黑树广泛应用于C++的STL中，e.g. set、multiset、map、multimap；另外，Java的TreeMap和TreeSet也是使用红黑树来实现的。

# 红黑树

## 修正方式

红-黑树主要通过三种方式对平衡进行修正，改变节点颜色、左旋和右旋。



#### ①、改变节点颜色

　　![img](https://520li.oss-cn-hangzhou.aliyuncs.com/img/20200611012031.png)

新插入的节点为15，一般新插入颜色都为红色，那么我们发现直接插入会违反规则3，改为黑色却发现违反规则4。这时候我们将其父节点颜色改为黑色，父节点的兄弟节点颜色也改为黑色。通常其祖父节点50颜色会由黑色变为红色，但是由于50是根节点，所以我们这里不能改变根节点颜色。

#### ②、右旋

首先要说明的是节点本身是不会旋转的，旋转改变的是节点之间的关系，选择一个节点作为旋转的顶端，如果做一次右旋，这个顶端节点会向下和向右移动到它右子节点的位置，它的左子节点会上移到它原来的位置。右旋的顶端节点必须要有左子节点。

　　![img](https://520li.oss-cn-hangzhou.aliyuncs.com/img/20200611012133.gif)



#### ③、左旋

　左旋的顶端节点必须要有右子节点。

　　![img](https://520li.oss-cn-hangzhou.aliyuncs.com/img/20200611012146.gif)

**注意**：我们改变颜色也是为了帮助我们判断何时执行什么旋转，而旋转是为了保证树的平衡。光改变节点颜色是不能起到任何作用的，旋转才是关键的操作，在新增节点或者删除节点之后，可能会破坏二叉树的平衡，那么何时执行旋转以及执行什么旋转，这是我们需要重点关注的。

## 插入方式

如果是第一次插入，由于原树为空，所以只会违反红-黑树的规则2，所以只要把根节点涂黑即可；如果插入节点的父节点是黑色的，那不会违背红-黑树的规则，什么也不需要做；但是遇到如下三种情况，我们就要开始变色和旋转了：

- ①、插入节点的父节点和其叔叔节点（祖父节点的另一个子节点）均为红色。
- ②、插入节点的父节点是红色的，叔叔节点是黑色的，且插入节点是其父节点的右子节点。
- ③、插入节点的父节点是红色的，叔叔节点是黑色的，且插入节点是其父节点的左子节点。

下面我们挨个分析这三种情况都需要如何操作。

在下面的讨论中，使用N,P,G,U表示关联的节点。N(now)表示当前节点，P(parent)表示N的父节点，U(uncle)表示N的叔叔节点，G(grandfather)表示N的祖父节点，也就是P和U的父节点。

### 情况1：插入节点的父节点和其叔叔节点（祖父节点的另一个子节点）均为红色

此时，肯定存在祖父节点，但是不知道父节点是其左子节点还是右子节点，但是由于对称性，我们只要讨论出一边的情况，另一种情况自然也与之对应。这里考虑父节点是其祖父节点的左子节点的情况，如下左图所示：

![image-20200611012611121](https://520li.oss-cn-hangzhou.aliyuncs.com/img/20200611012612.png)

对于这种情况，我们要做的操作有：将**当前节点(4) 的父节点(5) 和叔叔节点(8) 涂黑，将祖父节点(7)涂红**,变成了上有图所示的情况。**再将当前节点指向其祖父节点，再次从新的当前节点开始算法**（具体看下面的步骤）。这样上右图就变成情况2了。

### 情况2：**插入节点的父节点是红色的，叔叔节点是黑色的，且插入节点是其父节点的右子节点**。

我们要做的操作有：**将当前节点(7)的父节点(2)作为新的节点，以新的当前节点为支点做左旋操作**。完成后如左下图所示，这样左下图就变成情况3了。



![image-20200611012555138](https://520li.oss-cn-hangzhou.aliyuncs.com/img/20200611012556.png)

### 情况3：**插入节点的父节点是红色，叔叔节点是黑色，且插入节点是其父节点的左子节点**。

我们要做的操作有：**将当前节点的父节点(7)涂黑，将祖父节点(11)涂红，在祖父节点为支点做右旋操作。最后把根节点涂黑**，整个红-黑树重新恢复了平衡，如右上图所示。至此，插入操作完成！

我们可以看出，如果是从情况1开始发生的，必然会走完情况2和3，也就是说这是一整个流程，当然咯，实际中可能不一定会从情况1发生，如果从情况2开始发生，那再走个情况3即可完成调整，如果直接只要调整情况3，那么前两种情况均不需要调整了。**故变色和旋转之间的先后关系可以表示为：变色->左旋->右旋。**

## 删除操作

面探讨完了红-黑树的插入操作，接下来讨论删除，红-黑树的删除和二叉查找树的删除是一样的，只不过删除后多了个平衡的修复而已。我们先来回忆一下二叉搜索树的删除：

- ①、如果待删除的节点没有子节点，那么直接删除即可。
- ②、如果待删除的节点只有一个子节点，那么直接删掉，并用其子节点去顶替它。
- ③、如果待删除的节点有两个子节点，这种情况比较复杂：首先找出它的后继节点，**然后处理“后继节点”和“被删除节点的父节点”之间的关系，最后处理“后继节点的子节点”和“被删除节点的子节点”之间的关系**。每一步中也会有不同的情况。

　　实际上，删除过程太复杂了，很多情况下会采用在节点类中添加一个删除标记，并不是真正的删除节点。详细的删除我们这里不做讨论。

## 红黑树的效率

红黑树的查找、插入和删除时间复杂度都为O(log2N)，额外的开销是每个节点的存储空间都稍微增加了一点，因为一个存储红黑树节点的颜色变量。插入和删除的时间要增加一个常数因子，因为要进行旋转，平均一次插入大约需要一次旋转，因此插入的时间复杂度还是O(log2N),(时间复杂度的计算要省略常数)，但实际上比普通的二叉树是要慢的。

大多数应用中，查找的次数比插入和删除的次数多，所以应用红黑树取代普通的二叉搜索树总体上不会有太多的时间开销。而且红黑树的优点是对于有序数据的操作不会慢到O(N)的时间复杂度。

# AVL树

从最底层的违反平衡条件的结点以下的三个结点开始，

1. 单旋：如果这三个结点连成一条直线，则直接旋转即可。旋转规则如下：
   - **直线方向为“左下——右上”，则右旋**；
   - **直线方向为“左上——右下”，则左旋**。

2. 双旋：如果是形成一个转角，则需先旋转成直线，再按照单旋的情形旋转。

输入关键字序列为 { 16, 3, 7, 11, 9, 26, 18, 14, 15 }，插入和调整过程如下：

![img](https://520li.oss-cn-hangzhou.aliyuncs.com/img/20200611013911.png)

![img](https://520li.oss-cn-hangzhou.aliyuncs.com/img/20200611013922.png)

![img](https://520li.oss-cn-hangzhou.aliyuncs.com/img/20200611013931.png)